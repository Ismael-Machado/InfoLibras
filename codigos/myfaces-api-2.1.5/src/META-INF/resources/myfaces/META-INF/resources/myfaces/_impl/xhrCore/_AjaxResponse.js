_MF_SINGLTN(_PFX_XHR+"_AjaxResponse",_MF_OBJECT,{RESP_PARTIAL:"partial-response",RESP_TYPE_ERROR:"error",RESP_TYPE_REDIRECT:"redirect",RESP_TYPE_CHANGES:"changes",CMD_CHANGES:"changes",CMD_UPDATE:"update",CMD_DELETE:"delete",CMD_INSERT:"insert",CMD_EVAL:"eval",CMD_ERROR:"error",CMD_ATTRIBUTES:"attributes",CMD_EXTENSION:"extension",CMD_REDIRECT:"redirect",P_VIEWSTATE:"javax.faces.ViewState",P_VIEWROOT:"javax.faces.ViewRoot",P_VIEWHEAD:"javax.faces.ViewHead",P_VIEWBODY:"javax.faces.ViewBody",processResponse:function(G,C){var B=C._mfInternal;B._updateElems=[];B._updateForms=[];B.appliedViewState=null;try{var J=this.attr("impl"),E=this._Lang;if(!G||!E.exists(G,"responseXML")){throw this.makeException(J.EMPTY_RESPONSE,J.EMPTY_RESPONSE,this._nameSpace,"processResponse","");}var F=G.responseXML;if(E.isXMLParseError(F)){throw this._raiseError("XML Parse Error","processResponse");}var I=F.childNodes[0];if("undefined"==typeof I||I==null){throw this._raiseError("No child nodes for response","processResponse");}else{if(I.tagName!=this.RESP_PARTIAL){I=I.nextSibling;if(!I||I.tagName!=this.RESP_PARTIAL){throw this._raiseError("Partial response not set","processResponse");}}}var K=I.childNodes.length;for(var H=0;H<K;H++){var A=I.childNodes[H];var D=A.tagName;if(D==this.CMD_ERROR){this.processError(G,C,A);}else{if(D==this.CMD_REDIRECT){this.processRedirect(G,C,A);}else{if(D==this.CMD_CHANGES){this.processChanges(G,C,A);}}}}this.fixViewStates(C);}finally{delete B._updateElems;delete B._updateForms;delete B.appliedViewState;}},fixViewStates:function(C){var B=this._Lang;var D=C._mfInternal;if(null==D.appliedViewState){return ;}if(this._RT.getLocalOrGlobalConfig(C,"no_portlet_env",false)){for(var A=document.forms.length-1;A>=0;A--){this._setVSTForm(C,document.forms[A]);}return ;}B.arrForEach(D._updateForms,B.hitch(this,function(E){this._setVSTForm(C,E);}),0,this);B.arrForEach(D._updateElems,B.hitch(this,function(E){this._setVSTInnerForms(C,E);}),0,this);},_setVSTForm:function(B,E){E=this._Lang.byId(E);var D=B._mfInternal;if(!E){return ;}var C=(E.elements)?E.elements[this.P_VIEWSTATE]:null;if(C){this._Dom.setAttribute(C,"value",D.appliedViewState);}else{if(!C){var A=this._Dom.getDummyPlaceHolder();A.innerHTML=["<input type='hidden'","id='",this.P_VIEWSTATE,"' name='",this.P_VIEWSTATE,"' value='",D.appliedViewState,"' />"].join("");try{E.appendChild(A.childNodes[0]);}finally{A.innerHTML="";}}}},_setVSTInnerForms:function(B,E){var A=this._Lang,D=this._Dom,E=D.byIdOrName(E);var F=D.findByTagName(E,"form",false);var C=A.hitch(this,function(G){this._setVSTForm(B,G);});try{A.arrForEach(F,C,0,this);}finally{C=null;}},processError:function(E,B,D){var C=D.firstChild.textContent||"",A=D.childNodes[1].firstChild.data||"";this.attr("impl").sendError(E,B,this.attr("impl").SERVER_ERROR,C,A);},processRedirect:function(D,B,C){var A=this._Lang;var E=C.getAttribute("url");if(!E){throw this._raiseError(A.getMessage("ERR_RED_URL",null,"_AjaxResponse.processRedirect"),"processRedirect");}E=A.trim(E);if(E==""){return false;}window.location=E;return true;},processChanges:function(F,C,E){var D=E.childNodes;var B=this._Lang;for(var A=0;A<D.length;A++){switch(D[A].tagName){case this.CMD_UPDATE:this.processUpdate(F,C,D[A]);break;case this.CMD_EVAL:B.globalEval(D[A].firstChild.data);break;case this.CMD_INSERT:this.processInsert(F,C,D[A]);break;case this.CMD_DELETE:this.processDelete(F,C,D[A]);break;case this.CMD_ATTRIBUTES:this.processAttributes(F,C,D[A]);break;case this.CMD_EXTENSION:break;default:throw this._raiseError("_AjaxResponse.processChanges: Illegal Command Issued","processChanges");}}return true;},processUpdate:function(G,B,D){if(D.getAttribute("id")==this.P_VIEWSTATE){var F=D.firstChild.nodeValue,A=B._mfInternal,J=this._Lang.hitch(this._Dom,this._Dom.fuzzyFormDetection),I=(A)?A["_mfSourceControlId"]:B.source.id,C=(A)?(document.forms[A["_mfSourceFormId"]]||J(I)):J(I);A.appliedViewState=F;if(!C){return true;}A._updateForms.push(C.id);}else{var H=this._Dom.concatCDATABlocks(D),L=null,E=this._Lang.hitch(this,this._pushOperationResult);switch(D.getAttribute("id")){case this.P_VIEWROOT:H=H.substring(H.indexOf("<html"));var K=this._replaceHead(G,B,H);L=("undefined"!=typeof K&&null!=K)?this._replaceBody(G,B,H,K):this._replaceBody(G,B,H);if(L){E(B,L);}break;case this.P_VIEWHEAD:this._replaceHead(G,B,H);break;case this.P_VIEWBODY:L=this._replaceBody(G,B,H);if(L){E(B,L);}break;default:L=this.replaceHtmlItem(G,B,D.getAttribute("id"),H);if(L){E(B,L);}break;}}return true;},_pushOperationResult:function(C,A){var F=C._mfInternal;var E=this._Lang.hitch(this,function(H){var G=this._Dom.getParent(H,"form");if(null!=G){F._updateForms.push(G.id||G);}else{F._updateElems.push(H.id||H);}});var D="undefined"!=typeof A.length&&"undefined"==typeof A.nodeType;if(D&&A.length){for(var B=0;B<A.length;B++){E(A[B]);}}else{if(!D){E(A);}}},_replaceHead:function(F,C,L){var D=this._Lang,I=this._Dom,G=this._RT.browser.isWebKit,J=(!G)?D.parseXML(L):null,E=null;if(!G&&D.isXMLParseError(J)){J=D.parseXML(L.replace(/<!\-\-[\s\n]*<!\-\-/g,"<!--").replace(/\/\/-->[\s\n]*\/\/-->/g,"//-->"));}if(G||D.isXMLParseError(J)){var B=new (this._RT.getGlobalConfig("updateParser",myfaces._impl._util._HtmlStripper))();var K=B.parse(L,"head");E=D.parseXML("<head>"+K+"</head>");if(D.isXMLParseError(E)){try{E=I.createElement("head");E.innerHTML=K;}catch(H){throw this._raiseError("Error head replacement failed reason:"+H.toString(),"_replaceHead");}}}else{E=J.getElementsByTagName("head")[0];}var A=I.findByTagNames(document.getElementsByTagName("head")[0],{"link":true,"style":true});I.runCss(E,true);I.deleteItems(A);I.runScripts(E,true);return J;},_replaceBody:function(D,B,G){var K=this._RT,E=this._Dom,N=this._Lang,H=document.getElementsByTagName("body")[0],M=document.createElement("div"),I=K.browser.isWebKit;M.id="myfaces_bodyplaceholder";E._removeChildNodes(H);H.innerHTML="";var O=H;O.appendChild(M);var F=null;var R=null;if(!I){R=(arguments.length>3)?arguments[3]:N.parseXML(G);}if(!I&&N.isXMLParseError(R)){R=N.parseXML(G.replace(/<!\-\-[\s\n]*<!\-\-/g,"<!--").replace(/\/\/-->[\s\n]*\/\/-->/g,"//-->"));}if(I||N.isXMLParseError(R)){var C=new (K.getGlobalConfig("updateParser",myfaces._impl._util._HtmlStripper))();F=C.parse(G,"body");}else{var A=R.getElementsByTagName("body")[0];var P=K.browser;if(!P.isIEMobile||P.isIEMobile>=7){for(var L=0;L<A.attributes.length;L++){var J=A.attributes[L].value;if(J){E.setAttribute(O,A.attributes[L].name,J);}}}}var C=new (K.getGlobalConfig("updateParser",myfaces._impl._util._HtmlStripper))();F=C.parse(G,"body");var Q=this.replaceHtmlItem(D,B,M,F);if(Q){this._pushOperationResult(B,Q);}return Q;},replaceHtmlItem:function(F,C,G,A){var B=this._Lang,E=this._Dom;var D=(!B.isString(G))?G:E.byIdOrName(G);if(!D){throw this._raisError(B.getMessage("ERR_ITEM_ID_NOTFOUND",null,"_AjaxResponse.replaceHtmlItem",(G)?G.toString():"undefined"));}return E.outerHTML(D,A);},processInsert:function(H,C,G){var F=this._Dom,B=this._Lang,E=this._parseInsertData(H,C,G);if(!E){return false;}var D=F.byIdOrName(E.opId);if(!D){throw this._raiseError(B.getMessage("ERR_PPR_INSERTBEFID_1",null,"_AjaxResponse.processInsert",E.opId),"processInsert");}var A=F[E.insertType](D,E.cDataBlock);if(A){this._pushOperationResult(C,A);}return true;},_parseInsertData:function(J,C,F){var G=this._Lang,M=this._Dom,H=M.concatCDATABlocks,N="insertBefore",D="insertAfter",B=F.getAttribute("id"),E=F.getAttribute("before"),K=F.getAttribute("after"),L={};if(B&&E&&!K){L.insertType=N;L.opId=E;L.cDataBlock=H(F);}else{if(B&&!E&&K){L.insertType=D;L.opId=K;L.cDataBlock=H(F);}else{if(!B){var I=F.childNodes[0].tagName;if(I!="before"&&I!="after"){throw this._raiseError(G.getMessage("ERR_PPR_INSERTBEFID"),"_parseInsertData");}I=I.toLowerCase();var A=F.childNodes[0].getAttribute("id");L.insertType=(I=="before")?N:D;L.opId=A;L.cDataBlock=H(F.childNodes[0]);}else{throw this._raiseError([G.getMessage("ERR_PPR_IDREQ"),"\n ",G.getMessage("ERR_PPR_INSERTBEFID")].join(""),"_parseInsertData");}}}L.opId=G.trim(L.opId);return L;},processDelete:function(G,C,F){var B=this._Lang,E=this._Dom,H=F.getAttribute("id");if(!H){throw this._raiseError(B.getMessage("ERR_PPR_UNKNOWNCID",null,"_AjaxResponse.processDelete",""),"processDelete");}var D=E.byIdOrName(H);if(!D){throw this._raiseError(B.getMessage("ERR_PPR_UNKNOWNCID",null,"_AjaxResponse.processDelete",H),"processDelete");}var A=this._Dom.getParent(D,"form");if(null!=A){C._mfInternal._updateForms.push(A);}E.deleteItem(D);return true;},processAttributes:function(F,A,C){var D=this._Lang,B=C.getAttribute("id");if(!B){throw this._raiseError("Error in attributes, id not in xml markup","processAttributes");}var K=C.childNodes;if(!K){return false;}for(var I=0;I<K.length;I++){var E=K[I],J=E.getAttribute("name"),H=E.getAttribute("value");if(!J){continue;}J=D.trim(J);if("undefined"==typeof H||null==H){H="";}switch(B){case this.P_VIEWROOT:throw this._raiseError(D.getMessage("ERR_NO_VIEWROOTATTR",null,"_AjaxResponse.processAttributes"),"processAttributes");case this.P_VIEWHEAD:throw this._raiseError(D.getMessage("ERR_NO_HEADATTR",null,"_AjaxResponse.processAttributes"),"processAttributes");case this.P_VIEWBODY:var G=document.getElementsByTagName("body")[0];this._Dom.setAttribute(G,J,H);break;default:this._Dom.setAttribute(document.getElementById(B),J,H);break;}}return true;},_raiseError:function(D,C,H,B){var G=this.attr("impl");var A=H||G.MALFORMEDXML;var E=B||G.MALFORMEDXML;var F=D||"";return this._Lang.makeException(A,E,this._nameSpace,C||((arguments.caller)?arguments.caller.toString():"_raiseError"),F);}});